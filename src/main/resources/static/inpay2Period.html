<!DOCTYPE HTML>
<HTML>
	<HEAD>
		<META charset="UTF-8"/>
		<META content="IE=edge" http-equiv="X-UA-Compatible"/>
		<META content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport"/>
		<TITLE>站內付 2.0</TITLE>
		<LINK href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,700;1,400;1,700&#38;family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&#38;display=swap" rel="stylesheet"/>
		<LINK crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" rel="stylesheet"/>
	</HEAD>
	<BODY class="mt-3 mb-3">
		<DIV class="container">
			<DIV id="ECPayPayment"></DIV>
			<FORM action="" method="post" name="payment">
				<DIV class="input-group mb-3">
					<DIV class="input-group-append">
						<INPUT class="form-control" name="payToken" type="text"/>
					</DIV>
				</DIV>
				<DIV class="input-group mb-3">
					<INPUT class="form-control" name="paymentType" type="text"/>
				</DIV>
				<BUTTON class="btn btn-primary" type="submit">付款</BUTTON>
			</FORM>
		</DIV>
		<SCRIPT src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></SCRIPT>
		<SCRIPT crossorigin="anonymous" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></SCRIPT>
		<SCRIPT crossorigin="anonymous" integrity="sha512-yUNtg0k40IvRQNR20bJ4oH6QeQ/mgs9Lsa6V+3qxTj58u2r+JiAYOhOW0o+ijuMmqCtCEg7LZRA+T4t84/ayVA==" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.perfect-scrollbar/1.5.0/perfect-scrollbar.min.js"></SCRIPT>
		<SCRIPT src="https://kit.fontawesome.com/5ed1767edc.js"></SCRIPT>
		<SCRIPT src="https://cdn.jsdelivr.net/npm/node-forge@0.7.0/dist/forge.min.js"></SCRIPT>
		<SCRIPT src="https://ecpg-stage.ecpay.com.tw/Scripts/sdk-1.0.0.js?t=20210121100116"></SCRIPT>
		<SCRIPT>
			$(document).ready(function () {
				$('FORM').get(0).reset();

				ECPay.initialize(
					ECPay.ServerType.Stage,
					1,
					function (errMsg) {
						if (errMsg !== null) {
							alert(errMsg);
						}
						$.post(
							'/inpay2/getTokenByTrade.json',
							function(data) {
								if (data.RtnCode === 1) {									
									try {
										ECPay.createPayment(
											data.Token,
											null === navigator.language.match(/^zh/gi) ? ECPay.Language.enUS : ECPay.Language.zhTW,
											function (errMsg) {
												if (errMsg !== null) {
													alert(errMsg);
												}
											}
										);
									} catch (err) {
										alert(err);
									}
								} else {
									alert(data.RtnMsg);
								}
							},
							'json'
						);
					}
				);

				$('FORM[name="payment"]').submit(function(event) {
					event.preventDefault();
					let form = this;
					try {
						ECPay.getPayToken(function (paymentInfo, errMsg) {
							if (errMsg !== null) {
								alert(errMsg);
								return false;
							}
							let payToken = paymentInfo.PayToken;
							$(form.payToken).val(
								payToken
							);
							$(form.paymentType).val(
								paymentInfo.PaymentType
							);
							$.post(
								`/inpay2/createPayment/${payToken}.json`,
								function(data) {
									console.log(data);
									if (data.ThreeDInfo.ThreeDURL) {
										location.replace(data.ThreeDInfo.ThreeDURL);
									} else {
										alert('呃!?');
									}
//									if (data.RtnCode === 1) {									
//										try {
//											ECPay.createPayment(
//												data.Token,
//												ECPay.Language.zhTW,
//												function (errMsg) {
//													if (errMsg !== null) {
//														alert(errMsg);
//													}
//												}
//											);
//										} catch (err) {
//											alert(err);
//										}
//									} else {
//										alert(data.RtnMsg);
//									}
								},
								'json'
							);
						});
					} catch (error) {
						alert(error);
					}
					return false;
				});
			});
		</SCRIPT>
	</BODY>
</HTML>